name: Build Windows

# Tento workflow se spustí při:
# - Push do main/master branch
# - Pull request do main/master branch
# - Manuálně přes GitHub Actions tab
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Umožňuje manuální spuštění

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest  # Použije Windows runner (virtuální Windows počítač)
    
    steps:
    # 1. Checkout kódu z repozitáře
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Setup Free Pascal Compiler
    - name: Setup Free Pascal Compiler
      run: |
        $fpcVersion = "3.2.2"
        $fpcInstaller = "$env:TEMP\fpc-installer.exe"
        
        # Download FPC from SourceForge
        # Chocolatey installs 32-bit only, but we need 64-bit for lazbuild
        # Use the combined installer which includes both 32-bit and 64-bit
        Write-Host "Downloading FPC 64-bit from SourceForge..."
        $fpcUrl = "https://sourceforge.net/projects/freepascal/files/Win32/$fpcVersion/fpc-$fpcVersion.win32.and.win64.exe/download"
        
        # Use curl with proper redirect handling
        Write-Host "Downloading FPC installer from: $fpcUrl"
        $ProgressPreference = 'SilentlyContinue'
        
        # Try curl first
        curl.exe -L --location-trusted -f -o $fpcInstaller $fpcUrl 2>&1 | Out-Null
        if ($LASTEXITCODE -ne 0 -or -not (Test-Path $fpcInstaller)) {
          Write-Host "curl failed, trying Invoke-WebRequest..."
          try {
            Invoke-WebRequest -Uri $fpcUrl -OutFile $fpcInstaller -UseBasicParsing -MaximumRedirection 10 -ErrorAction Stop
          } catch {
            Write-Host "ERROR: Download failed - $_"
            Write-Host "Trying alternative URL..."
            # Alternative: try the x86_64 specific installer
            $fpcUrlAlt = "https://sourceforge.net/projects/freepascal/files/Win32/$fpcVersion/fpc-$fpcVersion.x86_64-win64.exe/download"
            curl.exe -L --location-trusted -f -o $fpcInstaller $fpcUrlAlt 2>&1 | Out-Null
            if ($LASTEXITCODE -ne 0 -or -not (Test-Path $fpcInstaller)) {
              Write-Host "ERROR: All download attempts failed"
              exit 1
            }
          }
        }
        
        # Verify file size (should be > 10MB)
        $fileInfo = Get-Item $fpcInstaller
        Write-Host "Downloaded file size: $($fileInfo.Length) bytes"
        if ($fileInfo.Length -lt 10MB) {
          Write-Host "ERROR: File too small, may be HTML error page"
          Get-Content $fpcInstaller -TotalCount 10
          exit 1
        }
        
        # Verify EXE header (MZ)
        $fileBytes = [System.IO.File]::ReadAllBytes($fpcInstaller)
        if ($fileBytes.Length -lt 2 -or $fileBytes[0] -ne 0x4D -or $fileBytes[1] -ne 0x5A) {
          Write-Host "ERROR: Not a valid EXE file (missing MZ header)"
          exit 1
        }
        Write-Host "File verified as valid EXE"
        
        # Install FPC
        Write-Host "Installing FPC..."
        $fullInstallerPath = (Resolve-Path $fpcInstaller).Path
        $installProcess = Start-Process -FilePath $fullInstallerPath -ArgumentList "/VERYSILENT /NORESTART /DIR=C:\FPC" -Wait -PassThru -NoNewWindow
        if ($installProcess.ExitCode -ne 0) {
          Write-Host "ERROR: Installer exited with code $($installProcess.ExitCode)"
          exit 1
        }
        
        # Find FPC installation path (could be in different locations)
        Write-Host "Searching for FPC installation..."
        $possiblePaths = @(
          "C:\FPC\$fpcVersion\bin\x86_64-win64",
          "C:\FPC\$fpcVersion\bin\i386-win32",
          "C:\FPC\$fpcVersion\bin\win64",
          "C:\FPC\$fpcVersion\bin\win32",
          "C:\Program Files\FPC\$fpcVersion\bin\x86_64-win64",
          "C:\Program Files (x86)\FPC\$fpcVersion\bin\x86_64-win64",
          "C:\tools\freepascal\bin\x86_64-win64",
          "C:\tools\freepascal\bin\i386-win32"
        )
        
        $fpcPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            Write-Host "Found FPC at: $path"
            $fpcPath = $path
            break
          }
        }
        
        if (-not $fpcPath) {
          Write-Host "ERROR: FPC installation path not found in any expected location"
          Write-Host "Searching for fpc.exe or ppcx64.exe in C:\FPC..."
          $fpcExe = Get-ChildItem -Path "C:\FPC" -Recurse -Filter "fpc.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($fpcExe) {
            $fpcPath = $fpcExe.DirectoryName
            Write-Host "Found FPC executable at: $fpcPath"
          } else {
            $ppcExe = Get-ChildItem -Path "C:\FPC" -Recurse -Filter "ppcx64.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($ppcExe) {
              $fpcPath = $ppcExe.DirectoryName
              Write-Host "Found FPC compiler at: $fpcPath"
            }
          }
        }
        
        if (-not $fpcPath) {
          Write-Host "ERROR: Could not locate FPC installation"
          Write-Host "Contents of C:\FPC:"
          if (Test-Path "C:\FPC") {
            Get-ChildItem "C:\FPC" -Recurse -Directory | Select-Object -First 10 FullName
          }
          exit 1
        }
        
        # Add FPC to PATH
        $env:PATH = "$fpcPath;$env:PATH"
        echo "$fpcPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        Write-Host "Added to PATH: $fpcPath"
        
        # Verify installation
        Write-Host "Verifying FPC installation..."
        fpc -v
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: FPC verification failed"
          Write-Host "Trying to run fpc.exe directly from: $fpcPath"
          & "$fpcPath\fpc.exe" -v
          if ($LASTEXITCODE -ne 0) {
            exit 1
          }
        }
        
    # 3. Setup Lazarus IDE
    - name: Setup Lazarus IDE
      run: |
        $lazarusVersion = "3.0"
        $lazarusInstaller = "$env:TEMP\lazarus-installer.exe"
        
        # Try Chocolatey first (if available)
        Write-Host "Trying Chocolatey for Lazarus..."
        choco install lazarus --version=$lazarusVersion -y --no-progress 2>&1 | Out-Null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Lazarus installed via Chocolatey"
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          lazbuild --version 2>&1 | Out-Null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Lazarus verified successfully"
            exit 0
          }
        }
        
        # Fallback: Download from SourceForge
        Write-Host "Chocolatey failed or Lazarus not found, downloading from SourceForge..."
        $lazarusUrl = "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%20$lazarusVersion/lazarus-$lazarusVersion-fpc-3.2.2-win64.exe/download"
        
        # Use curl with proper redirect handling
        Write-Host "Downloading Lazarus installer..."
        $ProgressPreference = 'SilentlyContinue'
        curl.exe -L --location-trusted -f -o $lazarusInstaller $lazarusUrl
        if ($LASTEXITCODE -ne 0 -or -not (Test-Path $lazarusInstaller)) {
          Write-Host "ERROR: Download failed"
          exit 1
        }
        
        # Verify file size (should be > 50MB)
        $fileInfo = Get-Item $lazarusInstaller
        Write-Host "Downloaded file size: $($fileInfo.Length) bytes"
        if ($fileInfo.Length -lt 50MB) {
          Write-Host "ERROR: File too small, may be HTML error page"
          Get-Content $lazarusInstaller -TotalCount 10
          exit 1
        }
        
        # Verify EXE header (MZ)
        $fileBytes = [System.IO.File]::ReadAllBytes($lazarusInstaller)
        if ($fileBytes.Length -lt 2 -or $fileBytes[0] -ne 0x4D -or $fileBytes[1] -ne 0x5A) {
          Write-Host "ERROR: Not a valid EXE file (missing MZ header)"
          exit 1
        }
        Write-Host "File verified as valid EXE"
        
        # Install Lazarus
        Write-Host "Installing Lazarus IDE..."
        $fullInstallerPath = (Resolve-Path $lazarusInstaller).Path
        $installProcess = Start-Process -FilePath $fullInstallerPath -ArgumentList "/VERYSILENT /NORESTART /DIR=C:\lazarus" -Wait -PassThru -NoNewWindow
        if ($installProcess.ExitCode -ne 0) {
          Write-Host "ERROR: Installer exited with code $($installProcess.ExitCode)"
          exit 1
        }
        
        # Add Lazarus to PATH
        $lazarusPath = "C:\lazarus"
        if (-not (Test-Path $lazarusPath)) {
          Write-Host "ERROR: Lazarus installation path not found: $lazarusPath"
          exit 1
        }
        $env:PATH = "$lazarusPath;$env:PATH"
        echo "$lazarusPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
        # Verify installation
        Write-Host "Verifying Lazarus installation..."
        lazbuild --version
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Lazarus verification failed"
          exit 1
        }
        
    # 4. Build Client
    - name: Build Client
      run: |
        cd client
        lazbuild --build-mode=default fpc_atomic.lpi
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
    # 5. Build Launcher
    - name: Build Launcher
      run: |
        cd launcher
        lazbuild --build-mode=default atomic_launcher.lpi
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
    # 6. Build Server
    - name: Build Server
      run: |
        cd server
        lazbuild --build-mode=default atomic_server.lpi
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
    # 7. Build CD Data Extractor
    - name: Build CD Data Extractor
      run: |
        cd cd_data_extractor_src
        lazbuild --build-mode=default cd_data_extractor.lpi
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
    # 8. Create artifacts directory
    - name: Prepare artifacts
      run: |
        New-Item -ItemType Directory -Force -Path windows\bin
        Write-Host "Looking for compiled binaries..."
        
        # Binaries are compiled to the root directory (one level up from project folders)
        $binaries = @(
          "fpc_atomic.exe",
          "atomic_launcher.exe", 
          "atomic_server.exe",
          "cd_data_extractor.exe"
        )
        
        foreach ($bin in $binaries) {
          if (Test-Path $bin) {
            Write-Host "Found: $bin"
            Move-Item $bin "windows\bin\" -Force
          } else {
            Write-Host "WARNING: $bin not found"
          }
        }
        
        Write-Host "Artifacts prepared. Contents of windows\bin:"
        Get-ChildItem windows\bin\ | Format-Table
        
    # 9. Upload artifacts (soubory ke stažení)
    - name: Upload Windows binaries
      uses: actions/upload-artifact@v4
      with:
        name: windows-binaries
        path: windows/bin/*.exe
        retention-days: 30  # Uchovat 30 dní
