name: Build Windows

# Tento workflow se spustí při:
# - Push do main/master branch
# - Pull request do main/master branch
# - Manuálně přes GitHub Actions tab
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Umožňuje manuální spuštění

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest  # Použije Windows runner (virtuální Windows počítač)
    
    steps:
    # 1. Checkout kódu z repozitáře
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Setup Free Pascal Compiler using Chocolatey
    - name: Setup Free Pascal Compiler
      run: |
        Write-Host "Installing Free Pascal Compiler via Chocolatey..."
        # Chocolatey is pre-installed on GitHub Actions Windows runners
        choco install fpc --version=3.2.2 -y --no-progress
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Chocolatey installation failed"
          exit 1
        }
        
        # Refresh environment variables to pick up new PATH
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        
        # Ověřit instalaci
        Write-Host "Verifying FPC installation..."
        fpc -v
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: FPC verification failed"
          Write-Host "Trying to find FPC in common locations..."
          $commonPaths = @(
            "C:\FPC\3.2.2\bin\x86_64-win64",
            "C:\Program Files\FPC\3.2.2\bin\x86_64-win64",
            "$env:ProgramFiles\FPC\3.2.2\bin\x86_64-win64"
          )
          foreach ($path in $commonPaths) {
            if (Test-Path $path) {
              Write-Host "Found FPC at: $path"
              $env:PATH = "$path;$env:PATH"
              echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            }
          }
          fpc -v
          if ($LASTEXITCODE -ne 0) {
            exit 1
          }
        }
        
    # 3. Setup Lazarus IDE using Chocolatey
    - name: Setup Lazarus IDE
      run: |
        Write-Host "Installing Lazarus IDE via Chocolatey..."
        # Try to install lazarus via Chocolatey, if not available, fall back to manual download
        choco install lazarus --version=3.0 -y --no-progress 2>&1 | Tee-Object -Variable chocoOutput
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Chocolatey package not found, trying manual installation from SourceForge..."
          
          # Fallback to SourceForge download
          $lazarusVersion = "3.0"
          $lazarusUrl = "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%20$lazarusVersion/lazarus-$lazarusVersion-fpc-3.2.2-win64.exe/download"
          $lazarusInstaller = "$env:TEMP\lazarus-installer.exe"
          
          Write-Host "Downloading Lazarus IDE from SourceForge..."
          $ProgressPreference = 'SilentlyContinue'
          
          # Use curl (more reliable for SourceForge redirects)
          curl.exe -L --fail --silent --show-error -o $lazarusInstaller $lazarusUrl
          if ($LASTEXITCODE -ne 0 -or -not (Test-Path $lazarusInstaller)) {
            Write-Host "ERROR: Download failed"
            exit 1
          }
          
          # Verify file size
          $fileInfo = Get-Item $lazarusInstaller
          if ($fileInfo.Length -lt 50MB) {
            Write-Host "ERROR: File too small, download may have failed"
            exit 1
          }
          
          # Verify EXE header
          $fileBytes = [System.IO.File]::ReadAllBytes($lazarusInstaller)
          if ($fileBytes.Length -lt 2 -or $fileBytes[0] -ne 0x4D -or $fileBytes[1] -ne 0x5A) {
            Write-Host "ERROR: Downloaded file is not a valid EXE"
            exit 1
          }
          
          Write-Host "Installing Lazarus IDE..."
          $fullInstallerPath = (Resolve-Path $lazarusInstaller).Path
          $installProcess = Start-Process -FilePath $fullInstallerPath -ArgumentList "/VERYSILENT /NORESTART /DIR=C:\lazarus" -Wait -PassThru -NoNewWindow
          if ($installProcess.ExitCode -ne 0) {
            Write-Host "ERROR: Installer exited with code $($installProcess.ExitCode)"
            exit 1
          }
          
          # Add to PATH
          $lazarusPath = "C:\lazarus"
          if (-not (Test-Path $lazarusPath)) {
            Write-Host "ERROR: Lazarus installation path not found: $lazarusPath"
            exit 1
          }
          $env:PATH = "$lazarusPath;$env:PATH"
          echo "$lazarusPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        } else {
          # Chocolatey installed successfully, refresh PATH
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        }
        
        # Ověřit instalaci
        Write-Host "Verifying Lazarus installation..."
        lazbuild --version
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Lazarus verification failed"
          Write-Host "Trying to find lazbuild in common locations..."
          $commonPaths = @(
            "C:\lazarus",
            "C:\Program Files\Lazarus",
            "$env:ProgramFiles\Lazarus"
          )
          foreach ($path in $commonPaths) {
            $lazbuildPath = Join-Path $path "lazbuild.exe"
            if (Test-Path $lazbuildPath) {
              Write-Host "Found lazbuild at: $lazbuildPath"
              $env:PATH = "$path;$env:PATH"
              echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            }
          }
          lazbuild --version
          if ($LASTEXITCODE -ne 0) {
            exit 1
          }
        }
        
    # 4. Build Client
    - name: Build Client
      run: |
        cd client
        lazbuild --build-mode=default fpc_atomic.lpi
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
    # 5. Build Launcher
    - name: Build Launcher
      run: |
        cd launcher
        lazbuild --build-mode=default atomic_launcher.lpi
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
    # 6. Build Server
    - name: Build Server
      run: |
        cd server
        lazbuild --build-mode=default atomic_server.lpi
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
    # 7. Build CD Data Extractor
    - name: Build CD Data Extractor
      run: |
        cd cd_data_extractor_src
        lazbuild --build-mode=default cd_data_extractor.lpi
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
    # 8. Create artifacts directory
    - name: Prepare artifacts
      run: |
        New-Item -ItemType Directory -Force -Path windows\bin
        Write-Host "Looking for compiled binaries..."
        
        # Binaries are compiled to the root directory (one level up from project folders)
        $binaries = @(
          "fpc_atomic.exe",
          "atomic_launcher.exe", 
          "atomic_server.exe",
          "cd_data_extractor.exe"
        )
        
        foreach ($bin in $binaries) {
          if (Test-Path $bin) {
            Write-Host "Found: $bin"
            Move-Item $bin "windows\bin\" -Force
          } else {
            Write-Host "WARNING: $bin not found"
          }
        }
        
        Write-Host "Artifacts prepared. Contents of windows\bin:"
        Get-ChildItem windows\bin\ | Format-Table
        
    # 9. Upload artifacts (soubory ke stažení)
    - name: Upload Windows binaries
      uses: actions/upload-artifact@v4
      with:
        name: windows-binaries
        path: windows/bin/*.exe
        retention-days: 30  # Uchovat 30 dní
