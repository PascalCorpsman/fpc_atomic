name: Build macOS

# Tento workflow se spustí pouze:
# - Manuálně přes GitHub Actions tab
# Automatické spuštění je zakomentováno
on:
  # push:
  #   branches: [ main, master ]
  # pull_request:
  #   branches: [ main, master ]
  workflow_dispatch:  # Umožňuje manuální spuštění

jobs:
  build-macos-arm64:
    name: Build for macOS (ARM64)
    runs-on: macos-latest  # Použije macOS runner (Apple Silicon)
    
    steps:
    # 1. Checkout kódu z repozitáře
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Setup Free Pascal Compiler
    - name: Setup Free Pascal Compiler
      run: |
        # Nainstalovat FPC přes Homebrew
        brew install fpc
        
        # Ověřit instalaci
        fpc -v
        
    # 3. Setup Lazarus IDE
    - name: Setup Lazarus IDE
      run: |
        # Nainstalovat Lazarus přes Homebrew
        brew install --cask lazarus
        
        # Ověřit instalaci
        lazbuild --version
        
    # 4. Build Client
    - name: Build Client (ARM64)
      run: |
        cd client
        lazbuild --build-mode=macos_arm64 fpc_atomic.lpi
        
    # 5. Build Launcher
    - name: Build Launcher (ARM64)
      run: |
        cd launcher
        lazbuild --build-mode=macos_arm64 atomic_launcher.lpi
        
    # 6. Build Server
    - name: Build Server (ARM64)
      run: |
        cd server
        lazbuild --build-mode=macos_arm64 atomic_server.lpi
        
    # 7. Build CD Data Extractor
    - name: Build CD Data Extractor (ARM64)
      run: |
        cd cd_data_extractor_src
        lazbuild --build-mode=macos_arm64 cd_data_extractor.lpi
        
    # 8. Prepare artifacts
    - name: Prepare artifacts
      run: |
        mkdir -p macos/bin/arm64
        if [ -f "macos/bin/arm64/fpc_atomic" ]; then
          echo "Client built successfully"
        fi
        if [ -f "macos/bin/arm64/atomic_launcher" ]; then
          echo "Launcher built successfully"
        fi
        if [ -f "macos/bin/arm64/atomic_server" ]; then
          echo "Server built successfully"
        fi
        if [ -f "macos/bin/arm64/cd_data_extractor" ]; then
          echo "CD Data Extractor built successfully"
        fi
        
    # 9. Upload artifacts
    - name: Upload macOS ARM64 binaries
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm64-binaries
        path: macos/bin/arm64/*
        retention-days: 30

  build-macos-x86_64:
    name: Build for macOS (x86_64)
    runs-on: macos-13  # Použije macOS runner (Intel - starší verze, ale stále dostupná)
    
    steps:
    # 1. Checkout kódu z repozitáře
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Setup Free Pascal Compiler
    - name: Setup Free Pascal Compiler
      run: |
        brew install fpc
        
        # Ověřit instalaci
        fpc -v
        
    # 3. Setup Lazarus IDE
    - name: Setup Lazarus IDE
      run: |
        brew install --cask lazarus
        
        # Ověřit instalaci
        lazbuild --version
        
    # 4. Build Client
    - name: Build Client (x86_64)
      run: |
        cd client
        lazbuild --build-mode=macos_x86_64 fpc_atomic.lpi
        
    # 5. Build Launcher
    - name: Build Launcher (x86_64)
      run: |
        cd launcher
        lazbuild --build-mode=macos_x86_64 atomic_launcher.lpi
        
    # 6. Build Server
    - name: Build Server (x86_64)
      run: |
        cd server
        lazbuild --build-mode=macos_x86_64 atomic_server.lpi
        
    # 7. Build CD Data Extractor
    - name: Build CD Data Extractor (x86_64)
      run: |
        cd cd_data_extractor_src
        lazbuild --build-mode=macos_x86_64 cd_data_extractor.lpi
        
    # 8. Prepare artifacts
    - name: Prepare artifacts
      run: |
        mkdir -p macos/bin/x86_64
        if [ -f "macos/bin/x86_64/fpc_atomic" ]; then
          echo "Client built successfully"
        fi
        
    # 9. Upload artifacts
    - name: Upload macOS x86_64 binaries
      uses: actions/upload-artifact@v4
      with:
        name: macos-x86_64-binaries
        path: macos/bin/x86_64/*
        retention-days: 30

