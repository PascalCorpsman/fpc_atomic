name: Build and Release Fly.io Server

# Tento workflow buildne Docker image pro Fly.io server a vytvo콏칤 release
on:
  workflow_dispatch:  # Manu치ln칤 spu코t캩n칤
  push:
    tags:
      - 'v*'  # Spust칤 se p콏i vytvo콏en칤 tagu za캜칤naj칤c칤ho na 'v' (nap콏. v1.0.0)

jobs:
  build-and-release:
    name: Build Docker Image and Create Release
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout k칩du
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Setup Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    # 3. Login to GitHub Container Registry
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      
    # 4. Extract version from tag or use commit SHA
    - name: Extract version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="dev-${GITHUB_SHA::8}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=ghcr.io/${{ github.repository_owner }}/fpc-atomic-server:$VERSION" >> $GITHUB_OUTPUT
        echo "tag_latest=ghcr.io/${{ github.repository_owner }}/fpc-atomic-server:latest" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
      
    # 5. Build Docker image
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./flyio_server/Dockerfile
        push: true
        tags: |
          ${{ steps.version.outputs.tag }}
          ${{ steps.version.outputs.tag_latest }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      
    # 6. Create GitHub Release (pouze pro tagy)
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.version.outputs.version }}
        body: |
          ## FPC Atomic Server for Fly.io
          
          ### 游 Jak deploynout na Fly.io (bez Pascal compileru!)
          
          **Nejjednodu코코칤 zp콢sob - pou쬴jte p콏edp콏ipraven칳 Docker image:**
          
          1. **Nainstalujte Fly.io CLI:**
             ```bash
             curl -L https://fly.io/install.sh | sh
             ```
          
          2. **P콏ihlaste se:**
             ```bash
             flyctl auth login
             ```
          
          3. **Vytvo콏te nov칳 adres치콏 a st치hn캩te konfiguraci:**
             ```bash
             mkdir fpc-atomic-server && cd fpc-atomic-server
             curl -L https://github.com/${{ github.repository }}/releases/latest/download/fly.toml.example -o fly.toml
             ```
          
          4. **Upravte `fly.toml` - zm캩켿te `PavelZverina` na va코e GitHub username (pokud m치te fork):**
             ```toml
             [build]
               image = "ghcr.io/${{ github.repository_owner }}/fpc-atomic-server:latest"
             ```
          
          5. **Deploy na Fly.io:**
             ```bash
             flyctl launch
             ```
          
          **Alternativa - build z source k칩du:**
          
          Pokud chcete buildnout z source k칩du, naklonujte repozit치콏 a pou쬴jte `fly.toml` z adres치콏e `flyio_server/`.
          
          ### 游닍 Docker Image
          
          Image je dostupn칳 na GitHub Container Registry:
          - `ghcr.io/${{ github.repository_owner }}/fpc-atomic-server:${{ steps.version.outputs.version }}`
          - `ghcr.io/${{ github.repository_owner }}/fpc-atomic-server:latest`
          
          ### 游댢 Konfigurace
          
          - **Port:** 5521
          - **Region:** Frankfurt (fra) - lze zm캩nit v `fly.toml`
          - **Auto-shutdown:** 30 sekund ne캜innosti
          
          ### 游닇 Dokumentace
          
          V칤ce informac칤 najdete v [README.md](flyio_server/README.md)
        draft: false
        prerelease: false
        files: |
          flyio_server/README.md
          flyio_server/fly.toml.example
          flyio_server/Dockerfile
